# 자동 증권거래 시스템 프로세스

## 전체 흐름도

```
┌─────────────────────────────────────────────────────────────────┐
│                      시스템 시작 (main.py)                        │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: 초기화 및 인증                                          │
├─────────────────────────────────────────────────────────────────┤
│  1. 설정 파일 로드 (config.yaml)                                  │
│  2. OAuth 인증 토큰 발급 (au10001)                                │
│  3. 계좌 정보 확인                                                │
│  4. WebSocket 연결 초기화                                         │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: 계좌 상태 조회                                          │
├─────────────────────────────────────────────────────────────────┤
│  1. 예수금 조회 (kt00001)                                         │
│  2. 보유 종목 조회 (kt00018)                                      │
│  3. 미체결 주문 조회 (ka10075)                                    │
│  4. 계좌 수익률 조회 (ka10085)                                    │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  Phase 3: 실시간 데이터 수신 시작                                  │
├─────────────────────────────────────────────────────────────────┤
│  WebSocket 구독:                                                 │
│  - 실시간 현재가 (코드: 01)                                       │
│  - 실시간 호가 (코드: 02)                                         │
│  - 주문체결 (코드: 00)                                            │
│  - 잔고 업데이트 (코드: 04)                                       │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │   메인 트레이딩 루프 시작          │
        └──────────────┬───────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                   트레이딩 사이클 (무한 반복)                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 메인 트레이딩 사이클 상세

```
┌──────────────────────────────────────────────────────────────────┐
│                     트레이딩 사이클 시작                            │
└───────────────────────────┬──────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  Step 0: 종목 스캐닝 (신규 추가)         │
        ├───────────────────────────────────────┤
        │  Fast Scan (10초마다):                  │
        │  - 거래량 급증 종목 (ka10023)            │
        │  - 거래량 상위 종목 (ka10030)            │
        │  - 거래대금 상위 종목 (ka10032)          │
        │  - 등락률 상위 종목 (ka10027)            │
        │  → 기본 필터링 후 50종목 선별            │
        │                                        │
        │  Deep Scan (1분마다):                   │
        │  - 외국인/기관 매매 분석                 │
        │  - 호가 강도 분석                        │
        │  - 체결강도 분석                         │
        │  - 거래원 분석                           │
        │  → 점수 계산 후 20종목 선별              │
        │                                        │
        │  AI Scan (5분마다):                     │
        │  - Gemini 심층 분석                     │
        │  - 상승 가능성 평가                      │
        │  → 최종 5종목 매수 추천                  │
        └───────────────┬───────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │  Step 1: 시장 데이터 수집                │
        ├───────────────────────────────────────┤
        │  - 스캐닝 추천 종목 상세 조회            │
        │  - 보유 종목 현재가 모니터링             │
        │  - 외국인/기관 매매동향 (ka10008/09)     │
        │  - 차트 데이터 (ka10079~10083)          │
        └───────────────┬───────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │  Step 2: Gemini AI 분석 요청            │
        ├───────────────────────────────────────┤
        │  입력 데이터:                            │
        │  - 실시간 시세 데이터                    │
        │  - 차트 데이터 (봉/틱)                   │
        │  - 기관/외국인 매매 추이                 │
        │  - 거래량/호가 분석                      │
        │  - 현재 포트폴리오 상태                  │
        │  - 계좌 잔고/수익률                      │
        │                                        │
        │  AI 분석 항목:                          │
        │  1. 시장 상황 판단                       │
        │  2. 매수/매도 기회 발견                  │
        │  3. 리스크 평가                         │
        │  4. 포지션 크기 결정                     │
        └───────────────┬───────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │  Step 3: AI 의사결정                    │
        ├───────────────────────────────────────┤
        │  Gemini 응답:                           │
        │  {                                     │
        │    "action": "BUY" / "SELL" / "HOLD",  │
        │    "stock_code": "005930",             │
        │    "stock_name": "삼성전자",            │
        │    "quantity": 10,                     │
        │    "price": 70000,                     │
        │    "reason": "분석 근거...",            │
        │    "confidence": 0.85,                 │
        │    "risk_level": "MEDIUM"              │
        │  }                                     │
        └───────────────┬───────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │  Step 4: 안전성 검증                    │
        ├───────────────────────────────────────┤
        │  ✓ 투자 한도 검사                        │
        │    - 종목당 최대 투자금액 확인           │
        │    - 총 투자금액 확인                    │
        │                                        │
        │  ✓ 리스크 검사                          │
        │    - 일일 최대 손실 한도 확인            │
        │    - 현재 수익률 확인                    │
        │                                        │
        │  ✓ 주문 가능성 검사                     │
        │    - 예수금 확인 (kt00001)              │
        │    - 주문가능금액 확인 (kt00010)         │
        │                                        │
        │  ✓ 거래 규칙 검사                       │
        │    - 거래 시간 확인 (09:00~15:30)       │
        │    - 테스트 모드 여부                    │
        └───────────────┬───────────────────────┘
                        │
                ┌───────┴───────┐
                │               │
           검증 실패         검증 통과
                │               │
                ▼               ▼
        ┌───────────┐   ┌───────────────────────┐
        │ 로그 기록  │   │  Step 5: 주문 실행      │
        │ 다음 사이클│   ├───────────────────────┤
        └───────────┘   │  매수 주문:             │
                        │  - kt10000 호출         │
                        │  - 주문번호 저장        │
                        │                        │
                        │  매도 주문:             │
                        │  - kt10001 호출         │
                        │  - 주문번호 저장        │
                        └───────┬───────────────┘
                                │
                                ▼
                ┌───────────────────────────────┐
                │  Step 6: 주문 모니터링          │
                ├───────────────────────────────┤
                │  WebSocket으로 실시간 수신:     │
                │  - 주문 접수 확인 (코드: 00)    │
                │  - 체결 확인 (코드: 00)        │
                │  - 잔고 업데이트 (코드: 04)     │
                │                               │
                │  주기적 조회:                   │
                │  - 미체결 조회 (ka10075)       │
                │  - 체결 조회 (ka10076)         │
                └───────┬───────────────────────┘
                        │
                        ▼
                ┌───────────────────────────────┐
                │  Step 7: 포지션 관리            │
                ├───────────────────────────────┤
                │  체결 완료 후:                  │
                │  - 보유종목 업데이트            │
                │  - 손익 계산                   │
                │  - 손절/익절 트리거 설정        │
                │                               │
                │  미체결 주문 처리:              │
                │  - 일정 시간 후 정정/취소       │
                │  - kt10002 (정정)              │
                │  - kt10003 (취소)              │
                └───────┬───────────────────────┘
                        │
                        ▼
                ┌───────────────────────────────┐
                │  Step 8: 손익 모니터링          │
                ├───────────────────────────────┤
                │  - 실시간 평가손익 계산         │
                │  - 실현손익 조회 (ka10077)     │
                │  - 수익률 조회 (ka10085)       │
                │                               │
                │  손절/익절 체크:                │
                │  - 목표 수익률 도달 → 매도     │
                │  - 손실 한도 도달 → 매도       │
                └───────┬───────────────────────┘
                        │
                        ▼
                ┌───────────────────────────────┐
                │  Step 9: 데이터 저장 및 학습    │
                ├───────────────────────────────┤
                │  - 거래 기록 저장               │
                │  - 수익률 기록                 │
                │  - AI 결정 로그                │
                │  - 성과 분석 데이터             │
                └───────┬───────────────────────┘
                        │
                        ▼
                ┌───────────────────────────────┐
                │  대기 (설정된 주기)             │
                │  - 기본: 10초~30초              │
                └───────┬───────────────────────┘
                        │
                        └────► 트레이딩 사이클 반복
```

---

## 주요 시나리오별 상세 프로세스

### 시나리오 1: 신규 매수

```
1. 종목 발견
   └─► Gemini AI가 거래량 급증 종목 분석
        └─► 매수 신호 판단

2. 매수 전 검증
   ├─► 예수금 확인 (kt00001)
   ├─► 주문가능금액 확인 (kt00010)
   ├─► 투자한도 체크
   └─► 리스크 평가

3. 주문 실행
   └─► 매수 주문 (kt10000)
        ├─► 종목코드: 005930
        ├─► 수량: 10주
        ├─► 가격: 70,000원
        └─► 주문유형: 지정가

4. 체결 확인
   └─► WebSocket 실시간 수신 (코드: 00)
        ├─► 주문 접수: "접수되었습니다"
        ├─► 부분 체결: "5주 체결"
        └─► 전량 체결: "10주 체결 완료"

5. 포지션 등록
   └─► 보유종목에 추가
        ├─► 매수가: 70,000원
        ├─► 수량: 10주
        ├─► 목표가: 77,000원 (+10%)
        └─► 손절가: 66,500원 (-5%)
```

### 시나리오 2: 보유 종목 매도 (익절)

```
1. 가격 모니터링
   └─► WebSocket 실시간 현재가 수신
        └─► 현재가 77,500원 도달

2. 익절 조건 확인
   └─► 목표 수익률 +10% 달성
        └─► Gemini AI에게 매도 타이밍 확인 요청

3. AI 분석
   └─► 추가 상승 가능성 분석
        ├─► 거래량 추이
        ├─► 기관/외국인 매매
        └─► 호가 상황

4. 매도 결정
   └─► 매도 주문 (kt10001)
        ├─► 종목코드: 005930
        ├─► 수량: 10주
        ├─► 가격: 77,500원
        └─► 주문유형: 지정가

5. 체결 및 정산
   └─► 체결 확인
        └─► 실현손익: +75,000원
             └─► 기록 저장 및 분석
```

### 시나리오 3: 손절 실행

```
1. 손실 감지
   └─► 현재가 66,000원 (-5.7%)
        └─► 손절 라인 도달

2. 긴급 매도
   └─► 즉시 매도 주문 (kt10001)
        ├─► 주문유형: 시장가 (즉시 체결)
        └─► 전량 매도

3. 손실 기록
   └─► 실현손익: -40,000원
        └─► 일일 손실 누적 확인
             └─► 일일 한도 체크

4. 거래 중단 판단
   └─► 일일 최대 손실 50만원 중 40만원 사용
        └─► 거래 계속 (잔여 한도: 46만원)
```

### 시나리오 4: 미체결 처리

```
1. 미체결 발생
   └─► 매수 주문 10주 중 5주만 체결
        └─► 5분 경과

2. 상황 분석
   └─► Gemini AI 분석
        ├─► 현재 호가 상황
        ├─► 거래 체결 추이
        └─► 주문 정정/취소 판단

3. 정정 주문
   └─► 정정 주문 (kt10002)
        ├─► 가격 상향: 70,000 → 70,500원
        └─► 수량 유지: 5주

4. 또는 취소
   └─► 취소 주문 (kt10003)
        └─► 미체결 5주 전량 취소
```

---

## 리스크 관리 프로세스

```
┌─────────────────────────────────────────┐
│         리스크 관리 레이어                │
├─────────────────────────────────────────┤
│                                         │
│  Level 1: 주문 전 검증                   │
│  ├─ 종목당 최대 투자금액 (100만원)        │
│  ├─ 총 투자금액 한도                     │
│  └─ 예수금 잔액 확인                     │
│                                         │
│  Level 2: 포지션 관리                    │
│  ├─ 손절가 자동 설정 (-5%)               │
│  ├─ 익절가 자동 설정 (+10%)              │
│  └─ 실시간 모니터링                      │
│                                         │
│  Level 3: 일일 손실 한도                 │
│  ├─ 일일 최대 손실: 50만원               │
│  ├─ 한도 도달 시 거래 중단               │
│  └─► 다음날 자동 재개                    │
│                                         │
│  Level 4: 긴급 중단                      │
│  ├─ 시스템 오류 감지                     │
│  ├─ API 연결 끊김                        │
│  ├─ 비정상 거래 패턴                     │
│  └─► 전체 포지션 청산 및 중단            │
│                                         │
└─────────────────────────────────────────┘
```

---

## 데이터 흐름도

```
┌──────────────┐
│ 키움증권 API  │
└───────┬──────┘
        │ REST API 호출
        ▼
┌──────────────────┐
│  REST Client     │
│  (인증/시세/주문) │
└───────┬──────────┘
        │ 데이터 전달
        ▼
┌──────────────────────────────────────────┐
│          Data Processor                  │
│  - 데이터 정제                             │
│  - 형식 변환                               │
│  - 지표 계산                               │
└───────┬──────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────┐
│         Gemini AI Engine                 │
│  - 시장 분석                               │
│  - 매매 신호 생성                          │
│  - 리스크 평가                             │
└───────┬──────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────┐
│       Trading Strategy Layer             │
│  - AI 결정 검증                            │
│  - 안전성 체크                             │
│  - 주문 생성                               │
└───────┬──────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────┐
│       Order Execution                    │
│  - 주문 실행                               │
│  - 체결 확인                               │
│  - 포지션 관리                             │
└───────┬──────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────┐
│    WebSocket Client (실시간)              │
│  - 현재가 수신                             │
│  - 체결 알림                               │
│  - 잔고 업데이트                           │
└──────────────────────────────────────────┘
```

---

## 시간대별 동작

```
08:00 - 시스템 시작
       ├─ 설정 로드
       ├─ 인증
       └─ 계좌 상태 확인

08:30 - 장전 준비
       ├─ 시간외 시세 확인
       ├─ 관심종목 분석
       └─ 매매 전략 수립

09:00 - 장 시작
       ├─ 실시간 데이터 수신 시작
       ├─ AI 분석 시작
       └─ 자동 매매 활성화

09:00~15:20 - 활발한 거래 시간
              ├─ 10초마다 시장 분석
              ├─ 매수/매도 기회 포착
              └─ 포지션 관리

15:20~15:30 - 장 마감 준비
              ├─ 신규 매수 중단
              ├─ 보유 종목 정리 판단
              └─ 미체결 정리

15:30 - 장 마감
       ├─ 당일 거래 결산
       ├─ 수익률 계산
       ├─ 거래 로그 저장
       └─ 다음날 전략 준비

16:00 - 시스템 대기 모드
       └─ 다음날 08:00까지 대기
```

---

## 에러 처리 프로세스

```
┌─────────────────────┐
│   에러 발생          │
└──────┬──────────────┘
       │
       ▼
┌────────────────────────────────┐
│  에러 유형 판단                  │
├────────────────────────────────┤
│                                │
│  1. 네트워크 오류               │
│     └─► 재연결 시도 (3회)       │
│         └─► 실패시 긴급 중단    │
│                                │
│  2. 인증 만료                   │
│     └─► 토큰 재발급             │
│         └─► 거래 재개           │
│                                │
│  3. API 호출 제한               │
│     └─► 대기 후 재시도          │
│                                │
│  4. 주문 오류                   │
│     └─► 로그 기록               │
│         └─► 다음 사이클 진행    │
│                                │
│  5. 치명적 오류                 │
│     └─► 전체 포지션 청산        │
│         └─► 시스템 중단         │
│         └─► 관리자 알림         │
│                                │
└────────────────────────────────┘
```

---

## 모니터링 및 로깅

```
실시간 모니터링:
├─ 현재 포지션
├─ 평가 손익
├─ 실현 손익
├─ 미체결 주문
└─ 시스템 상태

로그 기록:
├─ 모든 API 호출
├─ AI 의사결정
├─ 주문 내역
├─ 체결 내역
├─ 에러 발생
└─ 성과 분석
```

이 프로세스가 실제로 구현될 자동 거래 시스템의 전체 흐름입니다!