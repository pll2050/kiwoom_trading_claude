# 종목 스캐닝 전략 (Stock Scanning Strategy)

> 상승 가능성이 높은 종목을 자동으로 발견하는 시스템

## 목차
1. [스캐닝 개요](#스캐닝-개요)
2. [스캐닝 기준](#스캐닝-기준)
3. [API 활용](#api-활용)
4. [스캐닝 프로세스](#스캐닝-프로세스)
5. [AI 분석 통합](#ai-분석-통합)

---

## 스캐닝 개요

### 목적
- 실시간으로 시장을 모니터링하여 상승 가능성이 높은 종목 자동 발견
- 기술적/거래량/기관 매매 등 다각도 분석
- Gemini AI와 연동하여 최종 매수 판단

### 스캐닝 주기
- **실시간 스캔**: 10초마다 (장중)
- **정밀 스캔**: 1분마다
- **전체 스캔**: 5분마다

---

## 스캐닝 기준

### 1. 거래량 급증 종목

**조건:**
- 전일 대비 거래량 300% 이상 급증
- 5분 평균 거래량 > 20일 평균의 200%
- 최소 거래대금: 10억원 이상

**사용 API:**
- ka10023: 거래량급증요청
- ka10030: 당일거래량상위요청
- ka10032: 거래대금상위요청

**점수:**
- 거래량 300~500% 증가: +20점
- 거래량 500~1000% 증가: +40점
- 거래량 1000% 이상: +60점

---

### 2. 가격 급등락 종목

**조건:**
- 전일 대비 +3% 이상 상승
- 고가 대비 -2% 이내 (고점 근처)
- 거래량 동반 상승

**사용 API:**
- ka10019: 가격급등락요청
- ka10027: 전일대비등락률상위요청
- ka10018: 고저가근접요청

**점수:**
- 등락률 +3~5%: +15점
- 등락률 +5~7%: +25점
- 등락률 +7% 이상: +35점
- 고가 대비 -1% 이내: +10점 추가

---

### 3. 외국인/기관 매수 종목

**조건:**
- 외국인 3일 연속 순매수
- 기관 당일 순매수 10억원 이상
- 개인 순매도 + 외국인/기관 순매수 패턴

**사용 API:**
- ka10008: 주식외국인종목별매매동향
- ka10009: 주식기관요청
- ka10034: 외인기간별매매상위요청
- ka10035: 외인연속순매매상위요청
- ka10131: 기관외국인연속매매현황요청

**점수:**
- 외국인 1일 순매수: +10점
- 외국인 2일 연속: +20점
- 외국인 3일 연속: +30점
- 기관 10억 이상 순매수: +20점
- 기관 50억 이상 순매수: +40점

---

### 4. 호가 강도 분석

**조건:**
- 매수호가 잔량 > 매도호가 잔량 (150% 이상)
- 호가 스프레드 좁음 (유동성 높음)
- 매수 우위 호가창

**사용 API:**
- ka10004: 주식호가요청
- ka10020: 호가잔량상위요청
- ka10021: 호가잔량급증요청

**점수:**
- 매수/매도 호가 비율 150%: +15점
- 매수/매도 호가 비율 200%: +25점
- 매수/매도 호가 비율 300% 이상: +35점

---

### 5. 체결강도 분석

**조건:**
- 체결강도 120% 이상 (매수 우세)
- 최근 30분 평균 체결강도 상승 추세
- 시간대별 체결강도 증가

**사용 API:**
- ka10046: 체결강도추이시간별요청
- ka10047: 체결강도추이일별요청

**점수:**
- 체결강도 120~150%: +15점
- 체결강도 150~200%: +25점
- 체결강도 200% 이상: +40점

---

### 6. 증권사 순매수 (거래원)

**조건:**
- 주요 증권사 (삼성/NH/미래 등) 순매수
- 거래원 집중도 높음
- 당일 거래원 순매수 상위

**사용 API:**
- ka10038: 종목별증권사순위요청
- ka10039: 증권사별매매상위요청
- ka10040: 당일주요거래원요청
- ka10042: 순매수거래원순위요청

**점수:**
- 주요 증권사 순매수: +10점
- 3개 이상 증권사 순매수: +20점
- 5개 이상 증권사 순매수: +30점

---

### 7. 프로그램 매매

**조건:**
- 프로그램 순매수 상위 50
- 프로그램 매매 비중 높음
- 차익거래/비차익 분석

**사용 API:**
- ka90003: 프로그램순매수상위50요청
- ka90004: 종목별프로그램매매현황요청
- ka90005: 프로그램매매추이요청 시간대별

**점수:**
- 프로그램 순매수: +15점
- 순매수 상위 50: +25점
- 순매수 상위 20: +35점

---

### 8. 기술적 지표

**조건:**
- RSI: 30~70 (과매수/과매도 아님)
- MACD: 골든크로스
- 이동평균선: 5일선 > 20일선 > 60일선 (정배열)
- 볼린저밴드: 중심선 돌파

**사용 API:**
- ka10079~10083: 차트 데이터 (틱/분/일/주/월봉)
- 자체 계산: RSI, MACD, 이동평균, 볼린저밴드

**점수:**
- RSI 적정: +10점
- MACD 골든크로스: +20점
- 이동평균 정배열: +20점
- 볼린저밴드 돌파: +15점

---

### 9. 테마/뉴스 분석

**조건:**
- 현재 핫한 테마 종목
- 뉴스 발생 종목
- 실시간 검색어 급등

**사용 API:**
- ka90001: 테마그룹별요청
- ka90002: 테마구성종목요청
- ka00198: 실시간종목조회순위

**점수:**
- 테마 관련: +15점
- 인기 테마 (상위 10): +25점
- 검색 순위 급등: +20점

---

### 10. 변동성완화장치 (VI) 분석

**조건:**
- VI 발동 후 재개 종목
- VI 발동 사유 분석 (급등/급락)
- VI 해제 후 거래 패턴

**사용 API:**
- ka10054: 변동성완화장치발동종목요청

**점수:**
- VI 발동 후 상승 재개: +20점
- VI 발동 없음: 0점
- VI 발동 후 하락: -20점

---

## 종합 점수 시스템

### 점수 계산
```python
total_score = (
    volume_score +          # 거래량 (최대 60점)
    price_score +           # 가격 (최대 45점)
    foreign_score +         # 외국인/기관 (최대 70점)
    bid_ask_score +         # 호가 (최대 35점)
    strength_score +        # 체결강도 (최대 40점)
    broker_score +          # 거래원 (최대 30점)
    program_score +         # 프로그램 (최대 35점)
    technical_score +       # 기술적지표 (최대 65점)
    theme_score +           # 테마 (최대 40점)
    vi_score                # VI (최대 20점)
)
# 총점: 440점 만점
```

### 등급 분류
- **S등급** (350점 이상): 매우 강력한 매수 신호
- **A등급** (280~349점): 강력한 매수 신호
- **B등급** (200~279점): 중간 매수 신호
- **C등급** (150~199점): 약한 매수 신호
- **D등급** (150점 미만): 관망

### 필터링 조건
- **필수 조건**: 최소 거래대금 10억원
- **제외 조건**:
  - 관리종목
  - 거래정지 종목
  - 상한가 종목 (추가 매수 불가)

---

## 스캐닝 프로세스

### Phase 1: 초기 스크리닝 (Fast Scan - 10초)

```
┌─────────────────────────────────────┐
│  Step 1: 거래량/거래대금 상위 조회    │
├─────────────────────────────────────┤
│  API 호출:                           │
│  - ka10030 (거래량상위 100종목)      │
│  - ka10032 (거래대금상위 100종목)    │
│  - ka10023 (거래량급증 100종목)      │
│                                     │
│  결과: 중복 제거 후 150~200종목      │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 2: 기본 필터링                 │
├─────────────────────────────────────┤
│  제외:                               │
│  - 거래대금 10억 미만                │
│  - 관리종목                          │
│  - 거래정지                          │
│  - 상한가                            │
│                                     │
│  결과: 80~120종목                    │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 3: 빠른 점수 계산              │
├─────────────────────────────────────┤
│  - 거래량 점수                       │
│  - 등락률 점수                       │
│  - 거래대금 점수                     │
│                                     │
│  상위 50종목만 선별                  │
└──────────────┬──────────────────────┘
               │
               ▼
        [정밀 스캔 대기열 추가]
```

### Phase 2: 정밀 스캔 (Deep Scan - 1분)

```
┌─────────────────────────────────────┐
│  Step 1: 외국인/기관 매매 분석       │
├─────────────────────────────────────┤
│  API 호출:                           │
│  - ka10008 (외국인매매동향)          │
│  - ka10009 (기관매매)                │
│  - ka10034 (외국인매매상위)          │
│  - ka10131 (연속매매현황)            │
│                                     │
│  외국인/기관 점수 계산               │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 2: 호가/체결 분석              │
├─────────────────────────────────────┤
│  API 호출:                           │
│  - ka10004 (호가)                    │
│  - ka10046 (체결강도)                │
│  - ka10020 (호가잔량상위)            │
│                                     │
│  호가/체결 점수 계산                 │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 3: 거래원 분석                 │
├─────────────────────────────────────┤
│  API 호출:                           │
│  - ka10038 (종목별증권사순위)        │
│  - ka10040 (주요거래원)              │
│  - ka10042 (순매수거래원순위)        │
│                                     │
│  거래원 점수 계산                    │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 4: 종합 점수 계산              │
├─────────────────────────────────────┤
│  모든 점수 합산                      │
│  상위 20종목 선별                    │
│                                     │
│  200점 이상만 AI 분석 대기열 추가    │
└──────────────┬──────────────────────┘
               │
               ▼
        [AI 분석 대기열 추가]
```

### Phase 3: AI 심층 분석 (AI Deep Analysis - 5분)

```
┌─────────────────────────────────────┐
│  Step 1: 차트 데이터 수집            │
├─────────────────────────────────────┤
│  API 호출:                           │
│  - ka10079 (틱차트)                  │
│  - ka10080 (분봉차트)                │
│  - ka10081 (일봉차트)                │
│                                     │
│  기술적 지표 계산:                   │
│  - RSI, MACD, 이동평균선             │
│  - 볼린저밴드, 스토캐스틱            │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 2: Gemini AI 분석 요청         │
├─────────────────────────────────────┤
│  입력 데이터:                        │
│  - 종목 기본 정보                    │
│  - 스캐닝 점수 및 상세 분석          │
│  - 차트 데이터 및 기술적 지표        │
│  - 외국인/기관 매매 추이             │
│  - 거래원 동향                       │
│  - 테마/뉴스 정보                    │
│                                     │
│  AI 분석 항목:                       │
│  1. 상승 가능성 평가 (0~100%)        │
│  2. 목표가 예측                      │
│  3. 리스크 평가                      │
│  4. 매수 타이밍 판단                 │
│  5. 투자 기간 추천 (단타/스윙)       │
│  6. 근거 및 이유                     │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  Step 3: AI 결과 검증                │
├─────────────────────────────────────┤
│  - AI 신뢰도 체크 (confidence)       │
│  - 리스크 수준 확인                  │
│  - 투자 한도 체크                    │
│                                     │
│  최종 판단:                          │
│  - 매수 추천 (상위 5종목)            │
│  - 관심 종목 (상위 10종목)           │
│  - 제외 (나머지)                     │
└──────────────┬──────────────────────┘
               │
               ▼
        [매매 대기열 추가]
```

---

## API 활용 전략

### 병렬 처리로 성능 최적화

```python
# 동시에 여러 API 호출
async def fast_scan():
    tasks = [
        get_volume_leaders(),      # ka10030
        get_price_movers(),        # ka10027
        get_turnover_leaders(),    # ka10032
        get_volume_surge(),        # ka10023
    ]
    results = await asyncio.gather(*tasks)
    return merge_and_filter(results)

# 정밀 스캔
async def deep_scan(stock_codes):
    tasks = [
        get_foreign_trading(codes),    # ka10008
        get_institution_trading(codes), # ka10009
        get_bid_ask(codes),            # ka10004
        get_strength(codes),           # ka10046
    ]
    results = await asyncio.gather(*tasks)
    return calculate_scores(results)
```

### API 호출 최적화

1. **캐싱 전략**
   - 종목 기본정보: 1시간 캐시
   - 차트 데이터: 5분 캐시
   - 실시간 시세: 캐시 없음

2. **배치 처리**
   - 한 번에 여러 종목 조회
   - API 호출 횟수 최소화

3. **우선순위 큐**
   - 점수 높은 종목 우선 분석
   - 제한된 리소스 효율적 사용

---

## Gemini AI 프롬프트 예시

```python
STOCK_ANALYSIS_PROMPT = """
당신은 전문 주식 애널리스트입니다. 다음 종목을 분석해주세요.

【종목 정보】
- 종목명: {stock_name}
- 종목코드: {stock_code}
- 현재가: {current_price}원
- 등락률: {change_rate}%

【스캐닝 점수】
- 종합 점수: {total_score}/440점 (등급: {grade})
- 거래량 점수: {volume_score}/60
- 외국인/기관 점수: {foreign_score}/70
- 기술적 지표 점수: {technical_score}/65
- 호가 강도: {bid_ask_score}/35

【거래 동향】
- 거래량: 전일대비 {volume_change}%
- 외국인 3일 순매수: {foreign_3days}억원
- 기관 당일 순매수: {inst_today}억원
- 주요 거래원: {top_brokers}

【차트 분석】
- RSI(14): {rsi}
- MACD: {macd_signal}
- 이동평균: {ma_status}
- 볼린저밴드: {bb_position}

【질문】
1. 이 종목의 단기 상승 가능성은 몇 %입니까? (0~100%)
2. 예상 목표가는 얼마입니까?
3. 주요 리스크 요인은 무엇입니까?
4. 지금 매수하는 것이 적절합니까?
5. 추천 투자 기간은? (단타/스윙/중장기)
6. 판단 근거를 구체적으로 설명해주세요.

다음 JSON 형식으로 답변해주세요:
{
  "probability": 85,
  "target_price": 75000,
  "risk_level": "MEDIUM",
  "buy_recommendation": "STRONG_BUY",
  "investment_period": "SWING",
  "reasoning": "상세한 분석 근거...",
  "confidence": 0.92
}
"""
```

---

## 실시간 모니터링 대시보드

```
┌─────────────────────────────────────────────────────────┐
│              종목 스캐닝 실시간 모니터링                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  [Fast Scan] 매 10초                                    │
│  ├─ 스캔 완료: 1,234종목                                 │
│  ├─ 필터링 후: 87종목                                    │
│  └─ 정밀 스캔 대기: 50종목                               │
│                                                         │
│  [Deep Scan] 매 1분                                     │
│  ├─ 분석 중: 12종목                                      │
│  ├─ 분석 완료: 38종목                                    │
│  └─ AI 분석 대기: 15종목                                 │
│                                                         │
│  [AI Analysis] 매 5분                                   │
│  ├─ AI 분석 중: 3종목                                    │
│  └─ 매수 추천: 2종목                                     │
│                                                         │
│  【매수 추천 종목】                                        │
│  1. 삼성전자 (005930) - S등급 (372점)                    │
│     상승확률: 88% | 목표가: 75,000원 | 리스크: LOW       │
│                                                         │
│  2. SK하이닉스 (000660) - A등급 (315점)                  │
│     상승확률: 76% | 목표가: 135,000원 | 리스크: MEDIUM   │
│                                                         │
│  【관심 종목】                                            │
│  3. NAVER (035420) - A등급 (289점)                      │
│  4. 카카오 (035720) - B등급 (245점)                      │
│  5. 현대차 (005380) - B등급 (223점)                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 통합 프로세스

```
매 10초:
└─► Fast Scan (거래량/가격 기본 스크리닝)
     └─► 50종목 선별

매 1분:
└─► Deep Scan (외국인/기관/호가/거래원 분석)
     └─► 20종목 선별 (200점 이상)

매 5분:
└─► AI Analysis (Gemini 심층 분석)
     └─► 5종목 매수 추천
          └─► 자동 매매 대기열 추가
               └─► 안전성 검증 후 주문 실행
```

---

## 설정 예시 (config/scanning_rules.yaml)

```yaml
scanning:
  # 스캔 주기
  fast_scan_interval: 10  # 초
  deep_scan_interval: 60  # 초
  ai_scan_interval: 300   # 초

  # 필터링 조건
  min_trading_value: 1000000000  # 최소 거래대금 10억
  min_score: 150  # 최소 점수
  ai_analysis_threshold: 200  # AI 분석 최소 점수

  # 점수 가중치
  weights:
    volume: 1.0
    price: 1.0
    foreign: 1.2  # 외국인/기관 중요도 높음
    bid_ask: 0.8
    strength: 1.0
    broker: 0.9
    program: 0.7
    technical: 1.1
    theme: 0.6
    vi: 0.5

  # 추천 기준
  grade_s_threshold: 350
  grade_a_threshold: 280
  grade_b_threshold: 200

  # AI 신뢰도
  min_ai_confidence: 0.7  # 최소 70% 신뢰도

  # 제외 조건
  exclude:
    - "관리종목"
    - "거래정지"
    - "상한가"
    - "투자주의"
```

이 스캐닝 시스템이 자동으로 유망 종목을 찾아내서 Gemini AI에게 분석을 맡기고, 최종적으로 매수 추천까지 해줍니다!
